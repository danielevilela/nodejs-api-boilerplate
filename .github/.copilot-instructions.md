# Copilot Instructions for Node.js API Backend Projects

## Project Overview

This document defines the coding standards, patterns, and architecture for Node.js backend API projects. Follow these guidelines to ensure consistency and maintainability across all backend services.

## Technology Stack

### Core Dependencies

- **Runtime**: Node.js with TypeScript
- **Framework**: Express.js
- **Validation**: Zod schemas
- **Logging**: Pino (structured logging)
- **Caching**: Redis with IORedis client
- **Documentation**: Swagger/OpenAPI with swagger-jsdoc
- **Security**: Helmet, CORS, express-rate-limit
- **Testing**: Jest with Supertest
- **Development**: ts-node-dev, ESLint, Prettier

### Required Package.json Scripts

```json
{
  "scripts": {
    "dev": "ts-node-dev --ignore-watch node_modules src/server.ts",
    "build": "tsc",
    "start": "node dist/server.ts",
    "lint": "eslint . --ext .ts",
    "lint:fix": "eslint . --ext .ts --fix",
    "format": "prettier --write \"src/**/*.ts\"",
    "format:check": "prettier --check \"src/**/*.ts\"",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  }
}
```

## Project Structure

### Mandatory Folder Structure

```
src/
├── app.ts              # Express app configuration
├── server.ts           # Server entry point
├── config/             # Configuration files
│   ├── env.ts          # Environment variables with Zod validation
│   ├── redis.ts        # Redis configuration
│   └── swagger.ts      # Swagger/OpenAPI configuration
├── middleware/         # Custom middleware
│   ├── errorHandler.ts # Global error handler
│   ├── errors.ts       # Custom error classes
│   ├── security.ts     # Security middleware (CORS, rate limiting, helmet)
│   ├── validate.ts     # Zod validation middleware
│   └── cache.ts        # Redis caching middleware
├── routes/             # Route handlers
│   ├── index.ts        # Route exports
│   └── *.routes.ts     # Individual route files
├── schemas/            # Zod validation schemas
│   └── *.schema.ts     # Schema definitions
├── services/           # Business logic services
├── utils/              # Utility functions
│   └── logger.ts       # Pino logger configuration
└── __tests__/          # Test files
    ├── setup.ts        # Test setup
    ├── teardown.ts     # Test teardown
    ├── helpers.ts      # Test utilities
    ├── integration/    # Integration tests
    └── unit/           # Unit tests
```

## Configuration Standards

### Environment Configuration (config/env.ts)

- Use Zod for environment variable validation
- Provide sensible defaults
- Export typed configuration object
- Include environment flags (isDevelopment, isProduction, isTest)

```typescript
import dotenv from 'dotenv';
import { z } from 'zod';

dotenv.config();

const envSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  PORT: z.coerce.number().default(3000),
  API_PREFIX: z.string().default('/api'),
  // Add more environment variables as needed
});

const envVars = envSchema.parse(process.env);

export const config = {
  env: envVars.NODE_ENV,
  port: envVars.PORT,
  apiPrefix: envVars.API_PREFIX,
  isDevelopment: envVars.NODE_ENV === 'development',
  isProduction: envVars.NODE_ENV === 'production',
  isTest: envVars.NODE_ENV === 'test',
} as const;
```

### TypeScript Configuration (tsconfig.json)

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "commonjs",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
```

## Coding Standards

### Error Handling

- Create custom `AppError` class extending Error
- Use centralized error handler middleware
- Provide specific error factory functions
- Log errors with structured data using Pino
- Return different error details based on environment

```typescript
export class AppError extends Error {
  public readonly statusCode: number;
  public readonly isOperational: boolean;

  constructor(message: string, statusCode: number, isOperational = true) {
    super(message);
    this.statusCode = statusCode;
    this.isOperational = isOperational;
    Error.captureStackTrace(this, this.constructor);
  }
}

// Factory functions for common errors
export const notFound = (message = 'Not Found'): AppError => new AppError(message, 404);
export const badRequest = (message = 'Bad Request'): AppError => new AppError(message, 400);
```

### Validation with Zod

- Create separate schema files for each entity
- Include Swagger JSDoc comments in schema files
- Use nested object validation for request parts (body, params, query)
- Provide descriptive error messages

```typescript
export const createUserSchema = z.object({
  body: z.object({
    username: z
      .string()
      .min(3, 'Username must be at least 3 characters')
      .max(50, 'Username must be less than 50 characters'),
    email: z.string().email('Invalid email address'),
  }),
});
```

### Middleware Patterns

- Security: Apply helmet, CORS, and rate limiting
- Validation: Use Zod validation middleware
- Caching: Implement Redis-based caching with TTL
- Logging: Use Pino HTTP middleware for request logging
- Error handling: Global error handler as final middleware

### Route Organization

- One file per resource (e.g., user.routes.ts)
- Use Express Router
- Apply middleware in logical order: validation → caching → handler
- Include comprehensive Swagger documentation
- Handle cache invalidation for mutations

```typescript
router.post('/', validate(createUserSchema), async (req, res, next) => {
  try {
    // Business logic here
    res.status(201).json({ message: 'User created successfully' });
  } catch (error) {
    next(error);
  }
});
```

### Logging Standards

- Use Pino for structured logging
- Configure different log levels per environment
- Use pino-pretty for development
- Log request/response cycles
- Include contextual information in logs
- Suppress logs during testing

```typescript
export const logger = pino({
  level: isTest ? 'error' : logLevel,
  transport: isDev
    ? {
        target: 'pino-pretty',
        options: {
          colorize: true,
          translateTime: 'SYS:standard',
          ignore: 'pid,hostname',
        },
      }
    : undefined,
});
```

## Security Standards

### Required Security Middleware

1. **Helmet**: Security headers
2. **CORS**: Cross-origin resource sharing
3. **Rate Limiting**: Prevent abuse
4. **Body Size Limiting**: Prevent large payloads
5. **Request Logging**: Audit trail

```typescript
// Apply in this order
app.use(pinoHttp({ logger }));
app.use(securityHeaders);
app.use(corsConfig);
app.use(rateLimiter);
app.use(express.json({ limit: '10kb' }));
```

### Environment-Specific Features

- Swagger docs only in development/test
- Cache management endpoints only in development
- Detailed error messages only in non-production
- Different log levels per environment

## Testing Standards

### Test Structure

- Separate unit and integration tests
- Use descriptive test names
- Create test helpers for common patterns
- Mock external dependencies
- Clean up resources in teardown

### Jest Configuration

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  testMatch: ['**/__tests__/**/*.test.ts'],
  setupFilesAfterEnv: ['<rootDir>/src/__tests__/setup.ts'],
  globalTeardown: '<rootDir>/src/__tests__/teardown.ts',
};
```

### Integration Test Patterns

```typescript
describe('User Routes', () => {
  const baseUrl = `${config.apiPrefix}/users`;

  it('should create a new user with valid data', async () => {
    const response = await request(app)
      .post(baseUrl)
      .send(validUser)
      .expect('Content-Type', /json/)
      .expect(201);

    expect(response.body.message).toBe('User created successfully');
  });
});
```

## Caching Strategy

### Redis Implementation

- Use Redis for caching with configurable TTL
- Implement cache invalidation patterns
- Handle Redis unavailability gracefully
- Provide cache statistics endpoints (dev only)
- Use meaningful cache key prefixes

### Cache Middleware Pattern

```typescript
router.get(
  '/:id',
  validate(getUserSchema),
  cacheMiddleware({ ttl: 600, keyPrefix: 'user' }),
  (req, res) => {
    // Handler logic
  }
);
```

## API Documentation

### Swagger/OpenAPI Standards

- Document all endpoints with Swagger JSDoc
- Include request/response schemas
- Provide example values
- Define reusable components
- Serve docs at `/docs` in development

### Response Format Standards

```typescript
// Success response
{
  "message": "Operation successful",
  "data": { /* response data */ },
  "cached": false // if applicable
}

// Error response
{
  "status": "error",
  "message": "Error description",
  "errors": [ /* validation errors if applicable */ ]
}
```

## Development Workflow

### Required Dev Dependencies

- ESLint with TypeScript support
- Prettier for code formatting
- Husky for git hooks
- ts-node-dev for development server
- Jest and Supertest for testing

### Git Hooks

- Pre-commit: Run linting and formatting
- Pre-push: Run tests

### Docker Support

- Include docker-compose.yml for Redis
- Provide both development and production configurations
- Use health checks for service dependencies

## Performance Guidelines

### Response Time Targets

- Health checks: < 100ms
- Cached responses: < 200ms
- Database queries: < 500ms
- Complex operations: < 2s

### Optimization Strategies

- Implement caching for read-heavy operations
- Use connection pooling for databases
- Limit response payload sizes
- Implement proper indexing strategies
- Monitor and log performance metrics

## Monitoring and Observability

### Health Check Requirements

- Basic health endpoint at `/api/health`
- Include service dependencies status
- Return JSON with timestamp and environment
- Log health check requests

### Logging Requirements

- Structured logging with Pino
- Include request IDs for tracing
- Log errors with full context
- Different log levels per environment
- Performance metrics logging

## Deployment Standards

### Environment Variables

- Use .env files for development
- Validate all environment variables
- Provide defaults where appropriate
- Document required vs optional variables

### Build Process

- TypeScript compilation to dist/
- Include all necessary files in build
- Optimize for production deployment
- Support containerization

Follow these standards to ensure consistent, maintainable, and secure Node.js API backends. All new projects should implement these patterns from the start.
